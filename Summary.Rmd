---
title: "Summary"
author: "Matt McLean"
date: "23/03/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(knitr)
library(sf)
library(mapview)
source("functions/plot_summary.R")
source("functions/climate_summary.R")

```
<!--- Configuration --->
```{r, echo=FALSE}
load(here::here("trial_data.Rdata"))
trees = all_data$trees
climate = all_data$climate
plots = all_data$plots
meta = all_data$meta
sites = distinct(select(merge(meta, plots, by="FID"), Location, FID, Lat, Lon), Location, FID, .keep_all = TRUE) #Location based on a plot not center of site
```

# Offsite Trial Reporting {.tabset}

## Study Information

## Graphical Comparisons

## Statistical Comparisons

## Appendix





## TODO: Move This
### Plot Summaries
```{r echo=FALSE,results="asis"}
fids = as.data.frame(trees %>% distinct(FID))
for(id in 1:nrow(fids)) {
  feature <- as.vector(fids$FID[[id]])
  cat("  \n###",  feature, "  \n")
  print(kable(plot_summary(filter(trees, FID == feature))))
}
```

### Treatment Summaries
```{r echo=FALSE, results="asis"}
treatments = as.data.frame(trees %>% distinct(Species, Seedlot))
print(kable(treatment_summary(trees)))
cat("  \n###")
```
### Treatments by Species
```{r echo=FALSE, results="asis"}
treatments = as.data.frame(trees %>% distinct(Species))
print(kable(species_summary(trees)))
cat("  \n###")
```
### Treatments by Seedlot
```{r echo=FALSE, results="asis"}
treatments = as.data.frame(trees %>% distinct(Seedlot))
print(kable(seedlot_summary(trees)))
cat("  \n###")
```

### Plotting
Plot seedling condition by seedlot
```{r plot seedling condition echo-FALSE}

all_data$trees %>% 
  
  # need to convert seedlot to factor
  mutate(Seedlot=factor(Seedlot)) %>% 
  
  # Relevel condition factors
  mutate(Condition=fct_relevel(Condition,"Missing","Moribund","Poor","Fair","Good")) %>% # reorder levels
  
  # Create plot summaries
  group_by(FID,Plot,Species,Seedlot,Condition) %>% 
  summarise(n=n()) %>% # summarize number of trees at FID/Plot/Species/Condition
  
  # Let's create plot means and error bars
  ungroup() %>% 
  group_by(Species,Seedlot,Condition) %>% 
  summarise(Condition.Mean=mean(n)) %>% 
  
  # Plotting
  ggplot()+
  aes(x=Seedlot,y=Condition.Mean,color=Condition,fill=Condition)+
  geom_bar(stat="Identity")+
  facet_wrap(~Species,ncol=3,scales="free_x")+
  theme(legend.position = "bottom")



```


### Spatial analysis
```{r echo=FALSE,results="asis"}
  points <- st_as_sf(x = all_data$trees %>% mutate(Condition=fct_relevel(Condition,"Missing","Moribund","Poor","Fair","Good")), coords = c("Lat", "Lon"), crs = "+proj=longlat")
  
  #TODO: Reorder ledged, leaflet only supports alphabetical ledgends maybe use ggplot instead? 
  mapview(points["Condition"], col.regions = c("Missing" = "Black", "Moribund" = "Red", "Poor" = "Orange", "Fair" =  "Yellow", "Good" = "Green"), lwd = 0, cex = 5)
```
### Temperature
```{r echo=FALSE,results="asis"}
  climate_stats = temperature_summary(climate, 0)  %>% arrange(ClimateStationID)
  kable(climate_stats)
  
  ggplot(data=climate_stats, aes(x=ClimateStationID, y=num_events, fill=ClimateStationID)) + geom_bar(stat="identity") + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank()) + ggtitle("Number of events below threshold")
  
  #magnitude must be cast to character before numeric or conversion issues arrive
  ggplot(data=climate_stats, aes(x=ClimateStationID, y=as.numeric(as.character(max_magnitude)), fill=ClimateStationID)) + geom_bar(stat="identity") + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank()) + ggtitle("Maximum Magnitude at ClimateStationID")
  
  ggplot(data=climate_stats, aes(x=ClimateStationID, y=as.numeric(as.character(duration)), fill=ClimateStationID)) + geom_bar(stat="identity") + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank()) + ggtitle("Hours Below Threshold")
  
  cat("   \n")  
  
  climate_stats = temperature_events(climate, 0)
  for(table in 1:length(climate_stats)){
    cat("   \n###", names(climate_stats[table]))
    print(kable(climate_stats[[table]]))
  }
```

