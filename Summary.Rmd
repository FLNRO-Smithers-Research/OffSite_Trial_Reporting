---
title: "Summary"
author: "Matt McLean"
date: "23/03/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
source("plot_summary.R")
source("climate_summary.R")

```
<!--- Configuration --->
```{r, echo=FALSE}
load(here::here("trial_data.Rdata"))
trees = all_data$trees
climate = all_data$climate
```

# Offsite Trial Reporting

## Plot Summaries
```{r echo=FALSE,results="asis"}
fids = as.data.frame(trees %>% distinct(FID))
for(id in 1:nrow(fids)) {
  feature <- as.vector(fids$FID[[id]])
  cat("  \n###",  feature, "  \n")
  print(kable(plot_summary(filter(trees, FID == feature))))
}
```

## Treatment Summaries
```{r echo=FALSE, results="asis"}
treatments = as.data.frame(trees %>% distinct(Species, Seedlot))
print(kable(treatment_summary(trees)))
cat("  \n###")
```
## Treatments by Species
```{r echo=FALSE, results="asis"}
treatments = as.data.frame(trees %>% distinct(Species))
print(kable(species_summary(trees)))
cat("  \n###")
```
## Treatments by Seedlot
```{r echo=FALSE, results="asis"}
treatments = as.data.frame(trees %>% distinct(Seedlot))
print(kable(seedlot_summary(trees)))
cat("  \n###")
```
## Spatial analysis

# Temperature
```{r echo=FALSE,results="asis"}
  climate_stats = temperature_summary(climate, 0)  %>% arrange(ClimateStationID)
  kable(climate_stats)
  
  ggplot(data=climate_stats, aes(x=ClimateStationID, y=num_events, fill=ClimateStationID)) + geom_bar(stat="identity") + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank()) + ggtitle("Number of events below threshold")
  
  #magnitude must be cast to character before numeric or conversion issues arrive
  ggplot(data=climate_stats, aes(x=ClimateStationID, y=as.numeric(as.character(max_magnitude)), fill=ClimateStationID)) + geom_bar(stat="identity") + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank()) + ggtitle("Maximum Magnitude at ClimateStationID")
  
  ggplot(data=climate_stats, aes(x=ClimateStationID, y=as.numeric(as.character(duration)), fill=ClimateStationID)) + geom_bar(stat="identity") + theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.title.y=element_blank()) + ggtitle("Hours Below Threshold")
  
  cat("   \n")  
  
  climate_stats = temperature_events(climate, 0)
  for(table in 1:length(climate_stats)){
    cat("   \n###", names(climate_stats[table]))
    print(kable(climate_stats[[table]]))
  }
```

